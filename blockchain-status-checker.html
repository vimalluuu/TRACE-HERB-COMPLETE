<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRACE HERB - Blockchain Status Checker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(135deg, #16a34a, #15803d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #64748b;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .status-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .status-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.connected {
            background-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        .status-indicator.disconnected {
            background-color: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .status-indicator.warning {
            background-color: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .status-details {
            font-size: 0.9rem;
            color: #64748b;
            line-height: 1.6;
        }

        .status-details strong {
            color: #1e293b;
        }

        .check-button {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 0 auto 40px;
        }

        .check-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(22, 163, 74, 0.3);
        }

        .check-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .verdict {
            background: white;
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
        }

        .verdict.blockchain {
            border-color: #22c55e;
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
        }

        .verdict.demo {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
        }

        .verdict.error {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #fecaca);
        }

        .verdict h2 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 16px;
        }

        .verdict.blockchain h2 {
            color: #16a34a;
        }

        .verdict.demo h2 {
            color: #d97706;
        }

        .verdict.error h2 {
            color: #dc2626;
        }

        .verdict p {
            font-size: 1.1rem;
            color: #64748b;
            line-height: 1.6;
        }

        .transaction-test {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .transaction-test h4 {
            margin-bottom: 12px;
            color: #1e293b;
        }

        .transaction-test pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó TRACE HERB</h1>
            <p>Blockchain Status Checker</p>
        </div>

        <button class="check-button" onclick="checkBlockchainStatus()" id="checkBtn">
            üîç Check Blockchain Status
        </button>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Checking blockchain connection...</p>
        </div>

        <div id="statusGrid" class="status-grid" style="display: none;">
            <!-- Status cards will be populated here -->
        </div>

        <div id="verdict" class="verdict" style="display: none;">
            <!-- Final verdict will be shown here -->
        </div>
    </div>

    <script>
        async function checkBlockchainStatus() {
            const checkBtn = document.getElementById('checkBtn');
            const loading = document.getElementById('loading');
            const statusGrid = document.getElementById('statusGrid');
            const verdict = document.getElementById('verdict');

            // Show loading
            checkBtn.disabled = true;
            loading.style.display = 'block';
            statusGrid.style.display = 'none';
            verdict.style.display = 'none';

            try {
                // Check backend API
                const apiStatus = await checkAPI();
                
                // Check blockchain service
                const blockchainStatus = await checkBlockchain();
                
                // Test transaction
                const transactionStatus = await testTransaction();

                // Display results
                displayResults(apiStatus, blockchainStatus, transactionStatus);

            } catch (error) {
                console.error('Error checking blockchain status:', error);
                displayError(error.message);
            } finally {
                checkBtn.disabled = false;
                loading.style.display = 'none';
            }
        }

        async function checkAPI() {
            try {
                const response = await fetch('http://localhost:3000/api/health', {
                    method: 'GET',
                    timeout: 5000
                });
                
                return {
                    connected: response.ok,
                    status: response.status,
                    message: response.ok ? 'Backend API is running' : 'Backend API returned error'
                };
            } catch (error) {
                return {
                    connected: false,
                    status: 0,
                    message: `Backend API not accessible: ${error.message}`
                };
            }
        }

        async function checkBlockchain() {
            try {
                const response = await fetch('http://localhost:3000/api/health/blockchain', {
                    method: 'GET',
                    timeout: 10000
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const data = result.data || result; // Handle both formats
                    return {
                        connected: data.connected,
                        mode: data.mode,
                        networkName: data.networkName,
                        channelName: data.channelName,
                        peersConnected: data.peersConnected,
                        blockHeight: data.blockHeight,
                        transactionCount: data.transactionCount,
                        status: data.status,
                        certificateAuthorities: data.certificateAuthorities,
                        message: data.mode === 'ca-connected' ? 'Connected to Certificate Authorities' :
                                data.mode === 'blockchain' ? 'Connected to real blockchain' : 'Running in demo mode'
                    };
                } else {
                    return {
                        connected: false,
                        message: 'Blockchain service not responding'
                    };
                }
            } catch (error) {
                return {
                    connected: false,
                    message: `Cannot check blockchain status: ${error.message}`
                };
            }
        }

        async function testTransaction() {
            try {
                const testData = {
                    id: `TEST_${Date.now()}`,
                    qrCode: `QR_TEST_${Date.now()}`,
                    resourceType: 'CollectionEvent',
                    timestamp: new Date().toISOString(),
                    collector: { name: 'Test User', phone: '+91 9876543210' },
                    herb: { ayurvedicName: 'Test Herb', botanicalName: 'Testus herbicus' },
                    location: { latitude: 28.6139, longitude: 77.2090 },
                    status: 'collected'
                };

                const response = await fetch('http://localhost:3000/api/collection-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData),
                    timeout: 10000
                });

                if (response.ok) {
                    const result = await response.json();
                    return {
                        success: result.success,
                        transactionId: result.transactionId,
                        blockNumber: result.blockNumber,
                        message: result.success ? 'Transaction submitted successfully' : 'Transaction failed'
                    };
                } else {
                    return {
                        success: false,
                        message: 'Transaction submission failed'
                    };
                }
            } catch (error) {
                return {
                    success: false,
                    message: `Transaction test failed: ${error.message}`
                };
            }
        }

        function displayResults(apiStatus, blockchainStatus, transactionStatus) {
            const statusGrid = document.getElementById('statusGrid');
            const verdict = document.getElementById('verdict');

            // Create status cards
            statusGrid.innerHTML = `
                <div class="status-card">
                    <h3>
                        <span class="status-indicator ${apiStatus.connected ? 'connected' : 'disconnected'}"></span>
                        Backend API
                    </h3>
                    <div class="status-details">
                        <strong>Status:</strong> ${apiStatus.connected ? 'Connected' : 'Disconnected'}<br>
                        <strong>Message:</strong> ${apiStatus.message}
                    </div>
                </div>

                <div class="status-card">
                    <h3>
                        <span class="status-indicator ${blockchainStatus.connected ? (blockchainStatus.mode === 'blockchain' ? 'connected' : blockchainStatus.mode === 'ca-connected' ? 'connected' : 'warning') : 'disconnected'}"></span>
                        Blockchain Network
                    </h3>
                    <div class="status-details">
                        <strong>Mode:</strong> ${blockchainStatus.mode || 'Unknown'}<br>
                        <strong>Network:</strong> ${blockchainStatus.networkName || 'N/A'}<br>
                        <strong>Channel:</strong> ${blockchainStatus.channelName || 'N/A'}<br>
                        <strong>Peers:</strong> ${blockchainStatus.peersConnected || 'N/A'}<br>
                        ${blockchainStatus.certificateAuthorities ? `<strong>Certificate Authorities:</strong><br>${blockchainStatus.certificateAuthorities.map(ca => `&nbsp;&nbsp;‚Ä¢ ${ca}`).join('<br>')}<br>` : ''}
                        <strong>Message:</strong> ${blockchainStatus.message}
                    </div>
                </div>

                <div class="status-card">
                    <h3>
                        <span class="status-indicator ${transactionStatus.success ? 'connected' : 'disconnected'}"></span>
                        Transaction Test
                    </h3>
                    <div class="status-details">
                        <strong>Status:</strong> ${transactionStatus.success ? 'Success' : 'Failed'}<br>
                        <strong>Transaction ID:</strong> ${transactionStatus.transactionId || 'N/A'}<br>
                        <strong>Block Number:</strong> ${transactionStatus.blockNumber || 'N/A'}<br>
                        <strong>Message:</strong> ${transactionStatus.message}
                    </div>
                </div>
            `;

            // Determine verdict
            let verdictClass, verdictTitle, verdictText;

            if (blockchainStatus.connected && blockchainStatus.mode === 'blockchain') {
                verdictClass = 'blockchain';
                verdictTitle = '‚úÖ RUNNING ON REAL BLOCKCHAIN';
                verdictText = 'Your TRACE HERB system is successfully connected to Hyperledger Fabric blockchain network. All transactions are being recorded on the distributed ledger.';
            } else if (blockchainStatus.connected && blockchainStatus.mode === 'ca-connected') {
                verdictClass = 'blockchain';
                verdictTitle = 'üîó CONNECTED TO CERTIFICATE AUTHORITIES';
                verdictText = 'Your TRACE HERB system is connected to real Hyperledger Fabric Certificate Authorities. The blockchain network infrastructure is ready and operational.';
            } else if (blockchainStatus.connected && blockchainStatus.mode === 'demo') {
                verdictClass = 'demo';
                verdictTitle = '‚ö†Ô∏è RUNNING IN DEMO MODE';
                verdictText = 'Your system is working but using simulated blockchain. To connect to real blockchain, you need to set up and configure Hyperledger Fabric network.';
            } else {
                verdictClass = 'error';
                verdictTitle = '‚ùå BLOCKCHAIN CONNECTION ISSUES';
                verdictText = 'Your system is not properly connected to blockchain. Please check your network configuration and ensure all services are running.';
            }

            verdict.className = `verdict ${verdictClass}`;
            verdict.innerHTML = `
                <h2>${verdictTitle}</h2>
                <p>${verdictText}</p>
            `;

            statusGrid.style.display = 'grid';
            verdict.style.display = 'block';
        }

        function displayError(message) {
            const statusGrid = document.getElementById('statusGrid');
            const verdict = document.getElementById('verdict');

            verdict.className = 'verdict error';
            verdict.innerHTML = `
                <h2>‚ùå ERROR CHECKING STATUS</h2>
                <p>Unable to check blockchain status: ${message}</p>
            `;

            statusGrid.style.display = 'none';
            verdict.style.display = 'block';
        }

        // Auto-check on page load
        window.addEventListener('load', () => {
            setTimeout(checkBlockchainStatus, 1000);
        });
    </script>
</body>
</html>
